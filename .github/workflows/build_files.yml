name: Build All .NET Solutions

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  discover-and-build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Discover all .sln files
      - name: Discover .sln files
        id: discover
        run: |
          # Find all .sln files in subdirectories
          solutions=$(find . -type f -name "*.sln")
          if [ -z "$solutions" ]; then
            echo "No .sln files found!"
            echo "::set-output name=matrix::[]"
          else
            echo "Found solutions:"
            echo "$solutions"
            # Convert to JSON array for GitHub Actions matrix
            solutions_json=$(echo "$solutions" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "::set-output name=matrix::${solutions_json}"
          fi

      # Step 3: Set up .NET Core
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0 # Adjust the version as needed

  build:
    needs: discover-and-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        solution: ${{ fromJson(needs.discover-and-build.outputs.matrix) }}
      fail-fast: false
    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Build the solution
      - name: Build ${{ matrix.solution }}
        run: |
          echo "Building solution: ${{ matrix.solution }}"
          dotnet build "${{ matrix.solution }}" --configuration Release
